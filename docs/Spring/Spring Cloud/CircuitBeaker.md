## åˆ†å¸ƒå¼ç³»ç»Ÿé¢ä¸´çš„é—®é¢˜
å¤æ‚åˆ†å¸ƒå¼ä½“ç³»ç»“æ„ä¸­çš„åº”ç”¨ç¨‹åºæœ‰æ•°åä¸ªä¾èµ–å…³ç³»ï¼Œæ¯ä¸ªä¾èµ–å…³ç³»åœ¨æŸäº›æ—¶å€™å°†ä¸å¯é¿å…åœ°å¤±è´¥ã€‚![download.png](https://raw.githubusercontent.com/danmuking/image/main/4d46b31596b1eabc60f9fcd035b298c3.png)
### æœåŠ¡é›ªå´©
å¤šä¸ªå¾®æœåŠ¡ä¹‹é—´è°ƒç”¨çš„æ—¶å€™ï¼Œå‡è®¾å¾®æœåŠ¡Aè°ƒç”¨å¾®æœåŠ¡Bå’Œå¾®æœåŠ¡Cï¼Œå¾®æœåŠ¡Bå’Œå¾®æœåŠ¡Cåˆè°ƒç”¨å…¶å®ƒçš„å¾®æœåŠ¡ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„â€œæ‰‡å‡ºâ€ã€‚å¦‚æœæ‰‡å‡ºçš„é“¾è·¯ä¸ŠæŸä¸ªå¾®æœåŠ¡çš„è°ƒç”¨å“åº”æ—¶é—´è¿‡é•¿æˆ–è€…ä¸å¯ç”¨ï¼Œå¯¹å¾®æœåŠ¡Açš„è°ƒç”¨å°±ä¼šå ç”¨è¶Šæ¥è¶Šå¤šçš„ç³»ç»Ÿèµ„æºï¼Œè¿›è€Œå¼•èµ·ç³»ç»Ÿå´©æºƒï¼Œæ‰€è°“çš„â€œé›ªå´©æ•ˆåº”â€.
å¯¹äºé«˜æµé‡çš„åº”ç”¨æ¥è¯´ï¼Œå•ä¸€çš„åç«¯ä¾èµ–å¯èƒ½ä¼šå¯¼è‡´æ‰€æœ‰æœåŠ¡å™¨ä¸Šçš„æ‰€æœ‰èµ„æºéƒ½åœ¨å‡ ç§’é’Ÿå†…é¥±å’Œã€‚æ¯”å¤±è´¥æ›´ç³Ÿç³•çš„æ˜¯ï¼Œè¿™äº›åº”ç”¨ç¨‹åºè¿˜å¯èƒ½å¯¼è‡´æœåŠ¡ä¹‹é—´çš„å»¶è¿Ÿå¢åŠ ï¼Œå¤‡ä»½é˜Ÿåˆ—ï¼Œçº¿ç¨‹å’Œå…¶ä»–ç³»ç»Ÿèµ„æºç´§å¼ ï¼Œå¯¼è‡´æ•´ä¸ªç³»ç»Ÿå‘ç”Ÿæ›´å¤šçš„çº§è”æ•…éšœã€‚è¿™äº›éƒ½è¡¨ç¤ºéœ€è¦å¯¹æ•…éšœå’Œå»¶è¿Ÿè¿›è¡Œéš”ç¦»å’Œç®¡ç†ï¼Œä»¥ä¾¿å•ä¸ªä¾èµ–å…³ç³»çš„å¤±è´¥ï¼Œä¸èƒ½å–æ¶ˆæ•´ä¸ªåº”ç”¨ç¨‹åºæˆ–ç³»ç»Ÿã€‚
æ‰€ä»¥ï¼Œé€šå¸¸å½“ä½ å‘ç°ä¸€ä¸ªæ¨¡å—ä¸‹çš„æŸä¸ªå®ä¾‹å¤±è´¥åï¼Œè¿™æ—¶å€™è¿™ä¸ªæ¨¡å—ä¾ç„¶è¿˜ä¼šæ¥æ”¶æµé‡ï¼Œç„¶åè¿™ä¸ªæœ‰é—®é¢˜çš„æ¨¡å—è¿˜è°ƒç”¨äº†å…¶ä»–çš„æ¨¡å—ï¼Œè¿™æ ·å°±ä¼šå‘ç”Ÿçº§è”æ•…éšœï¼Œæˆ–è€…å«é›ªå´©ã€‚
## æˆ‘ä»¬çš„è¯‰æ±‚
é—®é¢˜ï¼š
ç¦æ­¢æœåŠ¡é›ªå´©æ•…éšœ
è§£å†³ï¼š 
- æœ‰é—®é¢˜çš„èŠ‚ç‚¹ï¼Œå¿«é€Ÿç†”æ–­ï¼ˆå¿«é€Ÿè¿”å›å¤±è´¥å¤„ç†æˆ–è€…è¿”å›é»˜è®¤å…œåº•æ•°æ®ã€æœåŠ¡é™çº§ã€‘ï¼‰ã€‚
â€œæ–­è·¯å™¨â€æœ¬èº«æ˜¯ä¸€ç§å¼€å…³è£…ç½®ï¼Œå½“æŸä¸ªæœåŠ¡å•å…ƒå‘ç”Ÿæ•…éšœä¹‹åï¼Œé€šè¿‡æ–­è·¯å™¨çš„æ•…éšœç›‘æ§ï¼ˆç±»ä¼¼ç†”æ–­ä¿é™©ä¸ï¼‰ï¼Œå‘è°ƒç”¨æ–¹è¿”å›ä¸€ä¸ªç¬¦åˆé¢„æœŸçš„ã€å¯å¤„ç†çš„å¤‡é€‰å“åº”(FallBack)ï¼Œè€Œä¸æ˜¯é•¿æ—¶é—´çš„ç­‰å¾…æˆ–è€…æŠ›å‡ºè°ƒç”¨æ–¹æ— æ³•å¤„ç†çš„å¼‚å¸¸ï¼Œè¿™æ ·å°±ä¿è¯äº†æœåŠ¡è°ƒç”¨æ–¹çš„çº¿ç¨‹ä¸ä¼šè¢«é•¿æ—¶é—´ã€ä¸å¿…è¦åœ°å ç”¨ï¼Œä»è€Œé¿å…äº†æ•…éšœåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„è”“å»¶ï¼Œä¹ƒè‡³é›ªå´©ã€‚
ä¸€å¥è¯ï¼Œå‡ºæ•…éšœäº†â€œä¿é™©ä¸â€è·³é—¸ï¼Œåˆ«æŠŠæ•´ä¸ªå®¶ç»™çƒ§äº†ï¼ŒğŸ˜„
## è§£å†³æ–¹æ¡ˆ

1. æœåŠ¡ç†”æ–­
2. æœåŠ¡é™çº§
3. æœåŠ¡é™æµ
4. æœåŠ¡é™æ—¶
5. æœåŠ¡é¢„çƒ­
## CircuitBeakeræ˜¯ä»€ä¹ˆ
circuit breakeræ˜¯ä¸€å¥—è§„èŒƒå’Œæ¥å£ï¼Œè½åœ°å®ç°è€…æ˜¯Resilience4J![download.png](https://raw.githubusercontent.com/danmuking/image/main/56c47830487d5fa3514e379332eebeb1.png)
### å®ç°åŸç†
CircuitBreakerçš„ç›®çš„æ˜¯ä¿æŠ¤åˆ†å¸ƒå¼ç³»ç»Ÿå…å—æ•…éšœå’Œå¼‚å¸¸ï¼Œæé«˜ç³»ç»Ÿçš„å¯ç”¨æ€§å’Œå¥å£®æ€§ã€‚
å½“ä¸€ä¸ªç»„ä»¶æˆ–æœåŠ¡å‡ºç°æ•…éšœæ—¶ï¼ŒCircuitBreakerä¼šè¿…é€Ÿåˆ‡æ¢åˆ°å¼€æ”¾OPENçŠ¶æ€(ä¿é™©ä¸è·³é—¸æ–­ç”µ)ï¼Œé˜»æ­¢è¯·æ±‚å‘é€åˆ°è¯¥ç»„ä»¶æˆ–æœåŠ¡ä»è€Œé¿å…æ›´å¤šçš„è¯·æ±‚å‘é€åˆ°è¯¥ç»„ä»¶æˆ–æœåŠ¡ã€‚è¿™å¯ä»¥å‡å°‘å¯¹è¯¥ç»„ä»¶æˆ–æœåŠ¡çš„è´Ÿè½½ï¼Œé˜²æ­¢è¯¥ç»„ä»¶æˆ–æœåŠ¡è¿›ä¸€æ­¥å´©æºƒï¼Œå¹¶ä½¿æ•´ä¸ªç³»ç»Ÿèƒ½å¤Ÿç»§ç»­æ­£å¸¸è¿è¡Œã€‚åŒæ—¶ï¼ŒCircuitBreakerè¿˜å¯ä»¥æé«˜ç³»ç»Ÿçš„å¯ç”¨æ€§å’Œå¥å£®æ€§ï¼Œå› ä¸ºå®ƒå¯ä»¥åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿçš„å„ä¸ªç»„ä»¶ä¹‹é—´è‡ªåŠ¨åˆ‡æ¢ï¼Œä»è€Œé¿å…å•ç‚¹æ•…éšœçš„é—®é¢˜ã€‚
## ![download.png](https://raw.githubusercontent.com/danmuking/image/main/a03f39cd7b0a360397ec201d23fb1ed0.png)Resilience4J
### æ˜¯ä»€ä¹ˆ
![download.png](https://raw.githubusercontent.com/danmuking/image/main/9f008554baefa3b8df2c9e8740ec57a4.png)
### èƒ½åšä»€ä¹ˆ
![download.png](https://raw.githubusercontent.com/danmuking/image/main/4f362eef96ec311b86c328743f00716c.png)
### ä½¿ç”¨æ•™ç¨‹
#### ç†”æ–­
##### çŠ¶æ€ä¹‹é—´çš„è½¬æ¢![download.png](https://raw.githubusercontent.com/danmuking/image/main/830f5d966017076d39d594eab43d89aa.png)
##### é…ç½®é¤æ•°![download.png](https://raw.githubusercontent.com/danmuking/image/main/2dc73673897fff5f2a51389b8d9405c2.png)![download.png](https://raw.githubusercontent.com/danmuking/image/main/95c5595b43c7b42a14d57a2c22d4073f.png)![download.png](https://raw.githubusercontent.com/danmuking/image/main/6d3010f4916fb0944cb59b17261472f7.png)![download.png](https://raw.githubusercontent.com/danmuking/image/main/eca312642cc1e6f4abfd12874ba6acdc.png)![download.png](https://raw.githubusercontent.com/danmuking/image/main/6d4b55541041ee0f2ec0d264b57a0c60.png)
##### COUNT_BASED
###### controller
```java
package com.atguigu.cloud.controller;

import cn.hutool.core.util.IdUtil;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RestController;

import java.util.concurrent.TimeUnit;

/**
 * @auther zzyy
 * @create 2023-11-13 14:55
 */
@RestController
public class PayCircuitController
{
    //=========Resilience4j CircuitBreaker çš„ä¾‹å­
    @GetMapping(value = "/pay/circuit/{id}")
    public String myCircuit(@PathVariable("id") Integer id)
    {
        if(id == -4) throw new RuntimeException("----circuit id ä¸èƒ½è´Ÿæ•°");
        if(id == 9999){
            try { TimeUnit.SECONDS.sleep(5); } catch (InterruptedException e) { e.printStackTrace(); }
        }
        return "Hello, circuit! inputId:  "+id+" \t " + IdUtil.simpleUUID();
    }
}
```
###### FeignApi
```java
package com.atguigu.cloud.apis;

import com.atguigu.cloud.entities.PayDTO;
import com.atguigu.cloud.resp.ResultData;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;

/**
 * @auther zzyy
 * @create 2023-11-09 15:29
 */
@FeignClient(value = "cloud-payment-service")
public interface PayFeignApi
{
    /**
     * æ–°å¢ä¸€æ¡æ”¯ä»˜ç›¸å…³æµæ°´è®°å½•
     * @param payDTO
     * @return
     */
    @PostMapping("/pay/add")
    public ResultData addPay(@RequestBody PayDTO payDTO);

    /**
     * æŒ‰ç…§ä¸»é”®è®°å½•æŸ¥è¯¢æ”¯ä»˜æµæ°´ä¿¡æ¯
     * @param id
     * @return
     */
    @GetMapping("/pay/get/{id}")
    public ResultData getPayInfo(@PathVariable("id") Integer id);

    /**
     * openfeignå¤©ç„¶æ”¯æŒè´Ÿè½½å‡è¡¡æ¼”ç¤º
     * @return
     */
    @GetMapping(value = "/pay/get/info")
    public String mylb();

    /**
     * Resilience4j CircuitBreaker çš„ä¾‹å­
     * @param id
     * @return
     */
    @GetMapping(value = "/pay/circuit/{id}")
    public String myCircuit(@PathVariable("id") Integer id);
}
```
###### POM
```java
<!--resilience4j-circuitbreaker-->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-circuitbreaker-resilience4j</artifactId>
</dependency>
<!-- ç”±äºæ–­è·¯ä¿æŠ¤ç­‰éœ€è¦AOPå®ç°ï¼Œæ‰€ä»¥å¿…é¡»å¯¼å…¥AOPåŒ… -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-aop</artifactId>
</dependency>
```
###### YML
```java
server:
  port: 80

spring:
  application:
    name: cloud-consumer-openfeign-order
  ####Spring Cloud Consul for Service Discovery
  cloud:
    consul:
      host: localhost
      port: 8500
      discovery:
        prefer-ip-address: true #ä¼˜å…ˆä½¿ç”¨æœåŠ¡ipè¿›è¡Œæ³¨å†Œ
        service-name: ${spring.application.name}
    openfeign:
      client:
        config:
          default:
            #cloud-payment-service:
            #è¿æ¥è¶…æ—¶æ—¶é—´ï¼Œä¸ºé¿å…æ¼”ç¤ºå‡ºé”™ï¼Œè®²è§£å®Œæœ¬æ¬¡å†…å®¹åè®¾ç½®ä¸º20ç§’
            connectTimeout: 20000
            #è¯»å–è¶…æ—¶æ—¶é—´ï¼Œä¸ºé¿å…æ¼”ç¤ºå‡ºé”™ï¼Œè®²è§£å®Œæœ¬æ¬¡å†…å®¹åè®¾ç½®ä¸º20ç§’
            readTimeout: 20000
            #å¼€å¯httpclient5
      httpclient:
        hc5:
          enabled: true
          #å¼€å¯å‹ç¼©ç‰¹æ€§
            compression:
        request:
          enabled: true
          min-request-size: 2048
          mime-types: text/xml,application/xml,application/json
        response:
          enabled: true
       # å¼€å¯circuitbreakerå’Œåˆ†ç»„æ¿€æ´» spring.cloud.openfeign.circuitbreaker.enabled
            circuitbreaker:
        enabled: true
        group:
          enabled: true #æ²¡å¼€åˆ†ç»„æ°¸è¿œä¸ç”¨åˆ†ç»„çš„é…ç½®ã€‚ç²¾ç¡®ä¼˜å…ˆã€åˆ†ç»„æ¬¡ä¹‹(å¼€äº†åˆ†ç»„)ã€é»˜è®¤æœ€å


# feignæ—¥å¿—ä»¥ä»€ä¹ˆçº§åˆ«ç›‘æ§å“ªä¸ªæ¥å£
logging:
  level:
    com:
      atguigu:
        cloud:
          apis:
            PayFeignApi: debug

# Resilience4j CircuitBreaker æŒ‰ç…§æ¬¡æ•°ï¼šCOUNT_BASED çš„ä¾‹å­
#  6æ¬¡è®¿é—®ä¸­å½“æ‰§è¡Œæ–¹æ³•çš„å¤±è´¥ç‡è¾¾åˆ°50%æ—¶CircuitBreakerå°†è¿›å…¥å¼€å¯OPENçŠ¶æ€(ä¿é™©ä¸è·³é—¸æ–­ç”µ)æ‹’ç»æ‰€æœ‰è¯·æ±‚ã€‚
#  ç­‰å¾…5ç§’åï¼ŒCircuitBreaker å°†è‡ªåŠ¨ä»å¼€å¯OPENçŠ¶æ€è¿‡æ¸¡åˆ°åŠå¼€HALF_OPENçŠ¶æ€ï¼Œå…è®¸ä¸€äº›è¯·æ±‚é€šè¿‡ä»¥æµ‹è¯•æœåŠ¡æ˜¯å¦æ¢å¤æ­£å¸¸ã€‚
#  å¦‚è¿˜æ˜¯å¼‚å¸¸CircuitBreaker å°†é‡æ–°è¿›å…¥å¼€å¯OPENçŠ¶æ€ï¼›å¦‚æ­£å¸¸å°†è¿›å…¥å…³é—­CLOSEé—­åˆçŠ¶æ€æ¢å¤æ­£å¸¸å¤„ç†è¯·æ±‚ã€‚
resilience4j:
  circuitbreaker:
    configs:
      default:
        failureRateThreshold: 50 #è®¾ç½®50%çš„è°ƒç”¨å¤±è´¥æ—¶æ‰“å¼€æ–­è·¯å™¨ï¼Œè¶…è¿‡å¤±è´¥è¯·æ±‚ç™¾åˆ†â½CircuitBreakerå˜ä¸ºOPENçŠ¶æ€ã€‚
                slidingWindowType: COUNT_BASED # æ»‘åŠ¨çª—å£çš„ç±»å‹
                slidingWindowSize: 6 #æ»‘åŠ¨çª—â¼çš„â¼¤â¼©é…ç½®COUNT_BASEDè¡¨ç¤º6ä¸ªè¯·æ±‚ï¼Œé…ç½®TIME_BASEDè¡¨ç¤º6ç§’
                minimumNumberOfCalls: 6 #æ–­è·¯å™¨è®¡ç®—å¤±è´¥ç‡æˆ–æ…¢è°ƒç”¨ç‡ä¹‹å‰æ‰€éœ€çš„æœ€å°æ ·æœ¬(æ¯ä¸ªæ»‘åŠ¨çª—å£å‘¨æœŸ)ã€‚å¦‚æœminimumNumberOfCallsä¸º10ï¼Œåˆ™å¿…é¡»æœ€å°‘è®°å½•10ä¸ªæ ·æœ¬ï¼Œç„¶åæ‰èƒ½è®¡ç®—å¤±è´¥ç‡ã€‚å¦‚æœåªè®°å½•äº†9æ¬¡è°ƒç”¨ï¼Œå³ä½¿æ‰€æœ‰9æ¬¡è°ƒç”¨éƒ½å¤±è´¥ï¼Œæ–­è·¯å™¨ä¹Ÿä¸ä¼šå¼€å¯ã€‚
                automaticTransitionFromOpenToHalfOpenEnabled: true # æ˜¯å¦å¯ç”¨è‡ªåŠ¨ä»å¼€å¯çŠ¶æ€è¿‡æ¸¡åˆ°åŠå¼€çŠ¶æ€ï¼Œé»˜è®¤å€¼ä¸ºtrueã€‚å¦‚æœå¯ç”¨ï¼ŒCircuitBreakerå°†è‡ªåŠ¨ä»å¼€å¯çŠ¶æ€è¿‡æ¸¡åˆ°åŠå¼€çŠ¶æ€ï¼Œå¹¶å…è®¸ä¸€äº›è¯·æ±‚é€šè¿‡ä»¥æµ‹è¯•æœåŠ¡æ˜¯å¦æ¢å¤æ­£å¸¸
                waitDurationInOpenState: 5s #ä»OPENåˆ°HALF_OPENçŠ¶æ€éœ€è¦ç­‰å¾…çš„æ—¶é—´
                permittedNumberOfCallsInHalfOpenState: 2 #åŠå¼€çŠ¶æ€å…è®¸çš„æœ€å¤§è¯·æ±‚æ•°ï¼Œé»˜è®¤å€¼ä¸º10ã€‚åœ¨åŠå¼€çŠ¶æ€ä¸‹ï¼ŒCircuitBreakerå°†å…è®¸æœ€å¤špermittedNumberOfCallsInHalfOpenStateä¸ªè¯·æ±‚é€šè¿‡ï¼Œå¦‚æœå…¶ä¸­æœ‰ä»»ä½•ä¸€ä¸ªè¯·æ±‚å¤±è´¥ï¼ŒCircuitBreakerå°†é‡æ–°è¿›å…¥å¼€å¯çŠ¶æ€ã€‚
                recordExceptions:
          - java.lang.Exception
    instances:
      cloud-payment-service:
        baseConfig: default
```
###### Controller
```java
package com.atguigu.cloud.controller;

import com.atguigu.cloud.apis.PayFeignApi;
import io.github.resilience4j.circuitbreaker.annotation.CircuitBreaker;
import jakarta.annotation.Resource;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RestController;

/**
 * @auther zzyy
 * @create 2023-11-13 14:54
 * Resilience4j CircuitBreaker çš„ä¾‹å­
 */
@RestController
public class OrderCircuitController
{
    @Resource
    private PayFeignApi payFeignApi;

    @GetMapping(value = "/feign/pay/circuit/{id}")
    @CircuitBreaker(name = "cloud-payment-service", fallbackMethod = "myCircuitFallback")
    public String myCircuitBreaker(@PathVariable("id") Integer id)
    {
        return payFeignApi.myCircuit(id);
    }
    //myCircuitFallbackå°±æ˜¯æœåŠ¡é™çº§åçš„å…œåº•å¤„ç†æ–¹æ³•
        public String myCircuitFallback(Integer id,Throwable t) {
        // è¿™é‡Œæ˜¯å®¹é”™å¤„ç†é€»è¾‘ï¼Œè¿”å›å¤‡ç”¨ç»“æœ
        return "myCircuitFallbackï¼Œç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åå†è¯•-----/(ã„’oã„’)/~~";
    }
}
```
##### TIME_BASED
![download.png](https://raw.githubusercontent.com/danmuking/image/main/ee1c170544f7fe73991fe7c4b1ea12aa.png)
###### YML
```java
server:
  port: 80

spring:
  application:
    name: cloud-consumer-openfeign-order
  ####Spring Cloud Consul for Service Discovery
  cloud:
    consul:
      host: localhost
      port: 8500
      discovery:
        prefer-ip-address: true #ä¼˜å…ˆä½¿ç”¨æœåŠ¡ipè¿›è¡Œæ³¨å†Œ
        service-name: ${spring.application.name}
    openfeign:
      client:
        config:
          default:
            #cloud-payment-service:
            #è¿æ¥è¶…æ—¶æ—¶é—´ï¼Œä¸ºé¿å…æ¼”ç¤ºå‡ºé”™ï¼Œè®²è§£å®Œæœ¬æ¬¡å†…å®¹åè®¾ç½®ä¸º20ç§’
            connectTimeout: 20000
            #è¯»å–è¶…æ—¶æ—¶é—´ï¼Œä¸ºé¿å…æ¼”ç¤ºå‡ºé”™ï¼Œè®²è§£å®Œæœ¬æ¬¡å†…å®¹åè®¾ç½®ä¸º20ç§’
            readTimeout: 20000
            #å¼€å¯httpclient5
      httpclient:
        hc5:
          enabled: true
          #å¼€å¯å‹ç¼©ç‰¹æ€§
      compression:
        request:
          enabled: true
          min-request-size: 2048
          mime-types: text/xml,application/xml,application/json
        response:
          enabled: true
      #å¼€å¯circuitbreakerå’Œåˆ†ç»„æ¿€æ´»
      circuitbreaker:
        enabled: true
        group:
          enabled: true #æ²¡å¼€åˆ†ç»„æ°¸è¿œä¸ç”¨åˆ†ç»„çš„é…ç½®ã€‚ç²¾ç¡®ä¼˜å…ˆã€åˆ†ç»„æ¬¡ä¹‹(å¼€äº†åˆ†ç»„)ã€é»˜è®¤æœ€å


# feignæ—¥å¿—ä»¥ä»€ä¹ˆçº§åˆ«ç›‘æ§å“ªä¸ªæ¥å£
logging:
  level:
    com:
      atguigu:
        cloud:
          apis:
            PayFeignApi: debug

# Resilience4j CircuitBreaker æŒ‰ç…§æ—¶é—´ï¼šTIME_BASED çš„ä¾‹å­
resilience4j:
  timelimiter:
    configs:
      default:
        timeout-duration: 10s #ç¥å‘çš„ä½ç½®ï¼Œtimelimiter é»˜è®¤é™åˆ¶è¿œç¨‹1sï¼Œè¶…äº1så°±è¶…æ—¶å¼‚å¸¸ï¼Œé…ç½®äº†é™çº§ï¼Œå°±èµ°é™çº§é€»è¾‘
  circuitbreaker:
    configs:
      default:
        failureRateThreshold: 50 #è®¾ç½®50%çš„è°ƒç”¨å¤±è´¥æ—¶æ‰“å¼€æ–­è·¯å™¨ï¼Œè¶…è¿‡å¤±è´¥è¯·æ±‚ç™¾åˆ†â½CircuitBreakerå˜ä¸ºOPENçŠ¶æ€ã€‚
        slowCallDurationThreshold: 2s #æ…¢è°ƒç”¨æ—¶é—´é˜ˆå€¼ï¼Œé«˜äºè¿™ä¸ªé˜ˆå€¼çš„è§†ä¸ºæ…¢è°ƒç”¨å¹¶å¢åŠ æ…¢è°ƒç”¨æ¯”ä¾‹ã€‚
        slowCallRateThreshold: 30 #æ…¢è°ƒç”¨ç™¾åˆ†æ¯”å³°å€¼ï¼Œæ–­è·¯å™¨æŠŠè°ƒç”¨æ—¶é—´â¼¤äºslowCallDurationThresholdï¼Œè§†ä¸ºæ…¢è°ƒç”¨ï¼Œå½“æ…¢è°ƒç”¨æ¯”ä¾‹é«˜äºé˜ˆå€¼ï¼Œæ–­è·¯å™¨æ‰“å¼€ï¼Œå¹¶å¼€å¯æœåŠ¡é™çº§
        slidingWindowType: TIME_BASED # æ»‘åŠ¨çª—å£çš„ç±»å‹
        slidingWindowSize: 2 #æ»‘åŠ¨çª—å£çš„å¤§å°é…ç½®ï¼Œé…ç½®TIME_BASEDè¡¨ç¤º2ç§’
        minimumNumberOfCalls: 2 #æ–­è·¯å™¨è®¡ç®—å¤±è´¥ç‡æˆ–æ…¢è°ƒç”¨ç‡ä¹‹å‰æ‰€éœ€çš„æœ€å°æ ·æœ¬(æ¯ä¸ªæ»‘åŠ¨çª—å£å‘¨æœŸ)ã€‚
        permittedNumberOfCallsInHalfOpenState: 2 #åŠå¼€çŠ¶æ€å…è®¸çš„æœ€å¤§è¯·æ±‚æ•°ï¼Œé»˜è®¤å€¼ä¸º10ã€‚
        waitDurationInOpenState: 5s #ä»OPENåˆ°HALF_OPENçŠ¶æ€éœ€è¦ç­‰å¾…çš„æ—¶é—´
        recordExceptions:
          - java.lang.Exception
    instances:
      cloud-payment-service:
        baseConfig: default 
```
#### éš”ç¦»
##### æ˜¯ä»€ä¹ˆ
bulkhead(èˆ¹çš„)èˆ±å£/(é£æœºçš„)éš”æ¿
éš”æ¿æ¥è‡ªé€ èˆ¹è¡Œä¸šï¼ŒåºŠä»“å†…éƒ¨ä¸€èˆ¬ä¼šåˆ†æˆå¾ˆå¤šå°éš”èˆ±ï¼Œä¸€æ—¦ä¸€ä¸ªéš”èˆ±æ¼æ°´å› ä¸ºéš”æ¿çš„å­˜åœ¨è€Œä¸è‡³äºå½±å“å…¶å®ƒéš”èˆ±å’Œæ•´ä½“èˆ¹ã€‚
![download.png](https://raw.githubusercontent.com/danmuking/image/main/da089dc90a7bca6772df8ac0f2dad5cc.png)
##### ä½œç”¨
é™åˆ¶å¹¶å‘
##### SemaphoreBulkHead
###### æ¦‚è¿°
åŸºæœ¬ä¸Šå°±æ˜¯æˆ‘ä»¬JUCä¿¡å·ç¯å†…å®¹çš„åŒæ ·æ€æƒ³![download.png](https://raw.githubusercontent.com/danmuking/image/main/4791681056180827a1904f1d5a09e989.png)
ä¿¡å·é‡èˆ±å£ï¼ˆSemaphoreBulkheadï¼‰åŸç†
å½“ä¿¡å·é‡æœ‰ç©ºé—²æ—¶ï¼Œè¿›å…¥ç³»ç»Ÿçš„è¯·æ±‚ä¼šç›´æ¥è·å–ä¿¡å·é‡å¹¶å¼€å§‹ä¸šåŠ¡å¤„ç†ã€‚
å½“ä¿¡å·é‡å…¨è¢«å ç”¨æ—¶ï¼Œæ¥ä¸‹æ¥çš„è¯·æ±‚å°†ä¼šè¿›å…¥é˜»å¡çŠ¶æ€ï¼ŒSemaphoreBulkheadæä¾›äº†ä¸€ä¸ªé˜»å¡è®¡æ—¶å™¨ï¼Œ
å¦‚æœé˜»å¡çŠ¶æ€çš„è¯·æ±‚åœ¨é˜»å¡è®¡æ—¶å†…æ— æ³•è·å–åˆ°ä¿¡å·é‡åˆ™ç³»ç»Ÿä¼šæ‹’ç»è¿™äº›è¯·æ±‚ã€‚
è‹¥è¯·æ±‚åœ¨é˜»å¡è®¡æ—¶å†…è·å–åˆ°äº†ä¿¡å·é‡ï¼Œé‚£å°†ç›´æ¥è·å–ä¿¡å·é‡å¹¶æ‰§è¡Œç›¸åº”çš„ä¸šåŠ¡å¤„ç†ã€‚
###### Controller
```java
//=========Resilience4j bulkhead çš„ä¾‹å­
@GetMapping(value = "/pay/bulkhead/{id}")
public String myBulkhead(@PathVariable("id") Integer id)
{
    if(id == -4) throw new RuntimeException("----bulkhead id ä¸èƒ½-4");

    if(id == 9999)
    {
        try { TimeUnit.SECONDS.sleep(5); } catch (InterruptedException e) { e.printStackTrace(); }
    }

    return "Hello, bulkhead! inputId:  "+id+" \t " + IdUtil.simpleUUID();
```
###### FeignApi
```java
/**
 * Resilience4j Bulkhead çš„ä¾‹å­
 * @param id
 * @return
 */
@GetMapping(value = "/pay/bulkhead/{id}")
public String myBulkhead(@PathVariable("id") Integer id);
```
###### POM
```java
<!--resilience4j-bulkhead-->
<dependency>
    <groupId>io.github.resilience4j</groupId>
    <artifactId>resilience4j-bulkhead</artifactId>
</dependency>
```
###### YML
```java
server:
  port: 80

spring:
  application:
    name: cloud-consumer-openfeign-order
  ####Spring Cloud Consul for Service Discovery
  cloud:
    consul:
      host: localhost
      port: 8500
      discovery:
        prefer-ip-address: true #ä¼˜å…ˆä½¿ç”¨æœåŠ¡ipè¿›è¡Œæ³¨å†Œ
        service-name: ${spring.application.name}
    openfeign:
      client:
        config:
          default:
          #cloud-payment-service:
            #è¿æ¥è¶…æ—¶æ—¶é—´ï¼Œä¸ºé¿å…æ¼”ç¤ºå‡ºé”™ï¼Œè®²è§£å®Œæœ¬æ¬¡å†…å®¹åè®¾ç½®ä¸º20ç§’
            connectTimeout: 20000
            #è¯»å–è¶…æ—¶æ—¶é—´ï¼Œä¸ºé¿å…æ¼”ç¤ºå‡ºé”™ï¼Œè®²è§£å®Œæœ¬æ¬¡å†…å®¹åè®¾ç½®ä¸º20ç§’
            readTimeout: 20000
            #å¼€å¯httpclient5
      httpclient:
        hc5:
          enabled: true
          #å¼€å¯å‹ç¼©ç‰¹æ€§
      compression:
        request:
          enabled: true
          min-request-size: 2048
          mime-types: text/xml,application/xml,application/json
        response:
          enabled: true
      #å¼€å¯circuitbreakerå’Œåˆ†ç»„æ¿€æ´»
      circuitbreaker:
        enabled: true
        group:
          enabled: true #æ²¡å¼€åˆ†ç»„æ°¸è¿œä¸ç”¨åˆ†ç»„çš„é…ç½®ã€‚ç²¾ç¡®ä¼˜å…ˆã€åˆ†ç»„æ¬¡ä¹‹(å¼€äº†åˆ†ç»„)ã€é»˜è®¤æœ€å


# feignæ—¥å¿—ä»¥ä»€ä¹ˆçº§åˆ«ç›‘æ§å“ªä¸ªæ¥å£
logging:
  level:
    com:
      atguigu:
        cloud:
          apis:
            PayFeignApi: debug

####resilience4j bulkhead çš„ä¾‹å­
resilience4j:
  bulkhead:
    configs:
      default:
        maxConcurrentCalls: 2 # éš”ç¦»å…è®¸å¹¶å‘çº¿ç¨‹æ‰§è¡Œçš„æœ€å¤§æ•°é‡
                maxWaitDuration: 1s # å½“è¾¾åˆ°å¹¶å‘è°ƒç”¨æ•°é‡æ—¶ï¼Œæ–°çš„çº¿ç¨‹çš„é˜»å¡æ—¶é—´ï¼Œæˆ‘åªæ„¿æ„ç­‰å¾…1ç§’ï¼Œè¿‡æ—¶ä¸å€™è¿›èˆ±å£å…œåº•fallback
    instances:
      cloud-payment-service:
        baseConfig: default
  timelimiter:
    configs:
      default:
        timeout-duration: 20s
```
###### Controller
```java
/**
 *(èˆ¹çš„)èˆ±å£,éš”ç¦»
 * @param id
 * @return
 */
@GetMapping(value = "/feign/pay/bulkhead/{id}")
@Bulkhead(name = "cloud-payment-service",fallbackMethod = "myBulkheadFallback",type = Bulkhead.Type.SEMAPHORE)
public String myBulkhead(@PathVariable("id") Integer id)
{
    return payFeignApi.myBulkhead(id);
}
public String myBulkheadFallback(Throwable t)
{
    return "myBulkheadFallbackï¼Œéš”æ¿è¶…å‡ºæœ€å¤§æ•°é‡é™åˆ¶ï¼Œç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åå†è¯•-----/(ã„’oã„’)/~~";
}

 
```
##### FixedThreadPoolBulkhead
###### æ¦‚è¿°
åŸºæœ¬ä¸Šå°±æ˜¯æˆ‘ä»¬JUC-çº¿ç¨‹æ± å†…å®¹çš„åŒæ ·æ€æƒ³
![download.png](https://raw.githubusercontent.com/danmuking/image/main/068a8030ae7e3024a287aace5d23e888.png)
å›ºå®šçº¿ç¨‹æ± èˆ±å£ï¼ˆFixedThreadPoolBulkheadï¼‰
FixedThreadPoolBulkheadçš„åŠŸèƒ½ä¸SemaphoreBulkheadä¸€æ ·ä¹Ÿæ˜¯ç”¨äºé™åˆ¶å¹¶å‘æ‰§è¡Œçš„æ¬¡æ•°çš„ï¼Œä½†æ˜¯äºŒè€…çš„å®ç°åŸç†å­˜åœ¨å·®åˆ«è€Œä¸”è¡¨ç°æ•ˆæœä¹Ÿå­˜åœ¨ç»†å¾®çš„å·®åˆ«ã€‚FixedThreadPoolBulkheadä½¿ç”¨ä¸€ä¸ªå›ºå®šçº¿ç¨‹æ± å’Œä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—æ¥å®ç°èˆ±å£ã€‚
å½“çº¿ç¨‹æ± ä¸­å­˜åœ¨ç©ºé—²æ—¶ï¼Œåˆ™æ­¤æ—¶è¿›å…¥ç³»ç»Ÿçš„è¯·æ±‚å°†ç›´æ¥è¿›å…¥çº¿ç¨‹æ± å¼€å¯æ–°çº¿ç¨‹æˆ–ä½¿ç”¨ç©ºé—²çº¿ç¨‹æ¥å¤„ç†è¯·æ±‚ã€‚
å½“çº¿ç¨‹æ± ä¸­æ— ç©ºé—²æ—¶æ—¶ï¼Œæ¥ä¸‹æ¥çš„è¯·æ±‚å°†è¿›å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œ
è‹¥ç­‰å¾…é˜Ÿåˆ—ä»ç„¶æ— å‰©ä½™ç©ºé—´æ—¶æ¥ä¸‹æ¥çš„è¯·æ±‚å°†ç›´æ¥è¢«æ‹’ç»ï¼Œ
åœ¨é˜Ÿåˆ—ä¸­çš„è¯·æ±‚ç­‰å¾…çº¿ç¨‹æ± å‡ºç°ç©ºé—²æ—¶ï¼Œå°†è¿›å…¥çº¿ç¨‹æ± è¿›è¡Œä¸šåŠ¡å¤„ç†ã€‚
å¦å¤–ï¼šThreadPoolBulkheadåªå¯¹CompletableFutureæ–¹æ³•æœ‰æ•ˆï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…åˆ›å»ºè¿”å›CompletableFutureç±»å‹çš„æ–¹æ³•
###### YML
```java
server:
  port: 80

spring:
  application:
    name: cloud-consumer-openfeign-order
  ####Spring Cloud Consul for Service Discovery
  cloud:
    consul:
      host: localhost
      port: 8500
      discovery:
        prefer-ip-address: true #ä¼˜å…ˆä½¿ç”¨æœåŠ¡ipè¿›è¡Œæ³¨å†Œ
        service-name: ${spring.application.name}
    openfeign:
      client:
        config:
          default:
            #cloud-payment-service:
            #è¿æ¥è¶…æ—¶æ—¶é—´ï¼Œä¸ºé¿å…æ¼”ç¤ºå‡ºé”™ï¼Œè®²è§£å®Œæœ¬æ¬¡å†…å®¹åè®¾ç½®ä¸º20ç§’
            connectTimeout: 20000
            #è¯»å–è¶…æ—¶æ—¶é—´ï¼Œä¸ºé¿å…æ¼”ç¤ºå‡ºé”™ï¼Œè®²è§£å®Œæœ¬æ¬¡å†…å®¹åè®¾ç½®ä¸º20ç§’
            readTimeout: 20000
            #å¼€å¯httpclient5
      httpclient:
        hc5:
          enabled: true
          #å¼€å¯å‹ç¼©ç‰¹æ€§
      compression:
        request:
          enabled: true
          min-request-size: 2048
          mime-types: text/xml,application/xml,application/json
        response:
          enabled: true
      #å¼€å¯circuitbreakerå’Œåˆ†ç»„æ¿€æ´»
      circuitbreaker:
        enabled: true
#        group:
#          enabled: true # æ¼”ç¤ºBulkhead.Type.THREADPOOLæ—¶spring.cloud.openfeign.circuitbreaker.group.enabled

è®¾ä¸ºfalseæ–°å¯çº¿ç¨‹å’ŒåŸæ¥ä¸»çº¿ç¨‹è„±ç¦»äº†ã€‚



# feignæ—¥å¿—ä»¥ä»€ä¹ˆçº§åˆ«ç›‘æ§å“ªä¸ªæ¥å£
logging:
  level:
    com:
      atguigu:
        cloud:
          apis:
            PayFeignApi: debug

####resilience4j bulkhead -THREADPOOLçš„ä¾‹å­
resilience4j:
  timelimiter:
    configs:
      default:
        timeout-duration: 10s #timelimiteré»˜è®¤é™åˆ¶è¿œç¨‹1sï¼Œè¶…è¿‡æŠ¥é”™ä¸å¥½æ¼”ç¤ºæ•ˆæœæ‰€ä»¥åŠ ä¸Š10ç§’
  thread-pool-bulkhead:
    configs:
      default:
        core-thread-pool-size: 1
        max-thread-pool-size: 1
        queue-capacity: 1
    instances:
      cloud-payment-service:
        baseConfig: default
# spring.cloud.openfeign.circuitbreaker.group.enabled è¯·è®¾ç½®ä¸ºfalse æ–°å¯çº¿ç¨‹å’ŒåŸæ¥ä¸»çº¿ç¨‹è„±ç¦»
```
