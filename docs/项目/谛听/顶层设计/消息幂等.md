## 消息重复避免
分布式下的一致性方案，我们都老生常谈了。几个关键点，**最终一致性** ，**持久化**，**重试**，**幂等**。在分布式场景下一般为了达到最终一致性，失败了我们也需要进行重试，重试就有幂等问题，如何标明两次重试是一次操作，不能因为重试插入了两条数据。
保证幂等关键的点就是幂等标识。
### 发送消息幂等
消息发送的时候，如果遇到网络波动，底层会自动帮忙重试。如何唯一的标识这条消息？靠的是发送端生成一个唯一的标识，如果重试的时候，相同的消息带的是相同的标识。后端服务就能够检测出来，保证幂等。
类似kafka发消息到broker的重试，也会在发送时生成个幂等标识。[腾讯sdk的文档](https://cloud.tencent.com/document/product/269/2282)，也能看到发送消息的一个随机md5，保证幂等标识。
![image.png](https://raw.githubusercontent.com/danmuking/image/main/af7d86218072a46e980c04fb64cfc308.png)
1s内的去重保证，是比较好的做法。否则需要去重判断的范围太大了，涉及的历史数据也太多了。这样的话，发送端的自动重试也要限制一下超过1s还没成功，就放弃重试了。
### 接收消息幂等
服务端对接收方的消息推送，也是有可靠性保证的。如果没有及时收到ack，定时任务就会进行消息推送重试。同样需要考虑到幂等问题。
假设服务端对接收方推送了相同的消息两次。接收方会怎么展示呢？一般能够想到对消息做幂等判断，如果是客户方已经展示的消息，就跳过。那么这个唯一性怎么判断呢？
消息的唯一性，基本就靠消息id来判断了。上面也讨论了消息id的唯一性问题。一般全局消息唯一的话。直接用唯一消息就好了。
如果是会话级别的消息id唯一，那判断的时候就需要判断`会话id+消息id`唯一。
