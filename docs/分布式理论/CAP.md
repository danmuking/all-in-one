分布式理论中，我碰到过最多的协议就是CAP。机会面试10次，至少会碰到3-4个面试官会问这个问题：你了解CAP理论吗？
## 2.1.概念
CAP原则又称CAP定理，指的是在一个分布式系统中Consistency（一致性）、 Availability（可用性）、Partition tolerance（分区容错性）这三个基本需求，最多只能同时满足其中的2个。

| 选项 | 描述 |
| --- | --- |
| Consistency（一致性） | 指数据在多个副本之间能够保持一致的特性（严格的一致性） |
| Availability（可用性） | 指系统提供的服务必须一直处于可用的状态，每次请求都能获取到非错的响应（不保证获取的数据为最新数据） |
| Partition tolerance（分区容错性） | 分布式系统在遇到任何网络分区故障的时候，仍然能够对外提供满足一致性和可用性的服务，除非整个网络环境都发生了故障 |

## 2.2.CAP为什么不可同时满足
看完上面的概念知识，我们来理解一下：**三个基本需求，最多只能同时满足其中两个。**
![](https://raw.githubusercontent.com/danmuking/image/main/77a6054ad2af46fa7752db27e83f9902.webp)
假设我们现在有一个电商网站，分布式异地部署。在上海与北京分别部署了两台服务器，均为独立的数据节点。用户请求域名进入CDN加速解析根据地域分别路由。南方路由到上海，北方路由到北京。并且两地的数据进行后台异步同步。
那么这里会存在什么问题呢？
分布式理论下一般情况都要满足P，那么在P为前提的情况下只能满足CP或者AP了。这个怎么看呢？
**举例：**
假设现在上海服务器所在机房出现了不可逆的地质灾害或者停电【比如前不久小破站出现的down机情况，哈哈】。
**AP**
在高并发情况下，上海节点部分业务数据还没有同步到北京的数据库中，此时为了保证高可用A的特性，则将请求转发到北京，牺牲了数据一致性C。
**CP**
但是比如银行转账这种强金融业务，数据一致性是很重要的，我转出去多少钱，别人就一定要收到多少钱。此时为了保证数据一致性，就要牺牲可用性了。因为你的转账数据节点是在上海的，如果这时路由转账数据至背景节点，数据就出现了不一致。
## 2.3.CP与AP怎么选择？
CAP不可同时满足，P又一定要保证，那么我们是选择CP还是选择AP呢？
对于多数大型互联网应用的场景，主机众多、部署分散。而且现在的集群规模越来越大，所以节点故障、网络故障是常态。比如电商网站浏览数据，如果部分节点挂了，肯定不会说不让你浏览商品了。你会明显的感受到数据加载数据变慢了【据说昨天双十一预售把淘宝干挂了，淘系的朋友们还好吗？3.25警告了！】，但是最终数据还是能加载出来。
当然如果涉及到金钱的系统，C是必须保证的。所以一般情况下金融系统都会选择后半夜发布，并且在发布的时候会增加提示语说系统升级，可能会导致部分功能不可用。这就是为了保证数据的一致性，牺牲了系统的可用性。
因此，CP好还是AP好这个是没有一个绝对的结论的，需要根据实际的场景来决定使用哪个理论。
## 2.4.各种中间件使用什么理论
**单节点mysql使用CA**
单节点的数据库就是典型是的使用CA原则，抛弃分区容错，保障了ACID特性。在数据库可用的同时保证了数据一致性。
**zookeeper选择CP**
zookeepr保证CP，即任何时刻对zookeeper的访问请求能得到一致性的数据结果，同时系统对网络分割具备容错性，但是它不能保证每次服务的可用性。从实际情况来分析，在使用zookeeper获取服务列表时，如果zk正在选举或者zk集群中半数以上的机器不可用，那么将无法获取数据。所以说，zk不能保证服务可用性。
**eureka选择AP**
eureka保证AP，eureka在设计时优先保证可用性，每一个节点都是平等的，一部分节点挂掉不会影响到正常节点的工作，不会出现类似zk的选举leader的过程，客户端发现向某个节点注册或连接失败，会自动切换到其他的节点，只要有一台eureka存在，就可以保证整个服务处在可用状态，只不过有可能这个服务上的信息并不是最新的信息。
**nacos支持CP，也支持AP**
与zookeepr,eureka不同的是，nacos既支持CP与AP
nacos会根据不同的实例类型选择不同的架构
```
yaml
复制代码spring:
  cloud:
    nacos:
      discovery:
        server-addr: 127.0.0.1:8848
        group:  baiyan
        cluster-name: BAIYAN
        ephemeral: false   //持久化实例，使用 CP架构
        ephemeral: true    //临时实例，使用 AP架构
```

1. 临时实例，选择AP架构，使用Distro协议，分布式协议的一种，阿里内部的协议，服务是放在内存中
2. 持久实例，选择CP架构，使用Raft协议来实现，点击查看Raft协议详情！服务是放在磁盘中

**redis集群**
通过自动分片和冗余数据，Redis具有了真正的分布式能力，某个结点挂了的话，因为数据在其他结点上有备份，所以其他结点顶上来就可以继续提供服务，保证了Availability。然而，也正因为这一点，Redis无法保证曾经的强一致性了。这也是CAP理论要求的，三者只能取其二。
**mysql主从**
与redis类似，一主多从，不保证数据数据节点同步的实时性，保证数据吞吐量使用AP，保证主从同步一致则使用CP.
**kafka集群**
Kafka的数据复制方案接近于Master-Slave，不同的是，Kafka既不是完全的同步复制，也不是完全的一步复制，而是基于ISR的动态复制方案。
只有被ISR中所有Replica同步的消息才被commit，但是Producer在写数据时，Leader不需要ISR中所有Replica同步该数据才确认收到数据。 Producer可以通过acks参数指定最少需要多少个Replica确认收到该消息才视为该消息发送成功。acks默认值为1，即Leader收到该消息后立即告诉Producer收到该消息，此时如果在ISR中的消息复制完该消息前Leader宕机，那该条消息会丢失。推荐做法是：将acks设置为all或-1，此时只有ISR中的所有Replica都收到该数据（也及消息被commit），Leader才会告诉Producer该消息发送成功，这样保证了不会有未知的数据丢失。
可以根据对于kafka的吞吐量的需求自由选择使用AP还是CP。
## 2.5.小结
CAP是一个纯理论层面的概念知识。但是很多中间件或者很多业务系统都是以这个理论为基础构建了分布式应用体系。CP与AP没有最好之分，只有场景合适之分。

## 参考资料
[一文吃透分布式理论【CAP,BASE深入解析】 - 掘金](https://juejin.cn/post/7021717177220726798)
