# 暴打MySQL之MySQL中数据是怎样组织的

## 随便聊聊

> 最近大致看完了小孩子老师的《MySQL是怎样运行的》，不禁纳头便拜，人与人的差距真是比人和猪的差距还要大。感慨之余，又扶手懊恼书中的细节是在太多，容易被花花细节迷了眼，完全没留下一点印象。我觉得对于普通后端程序员来说，最重要的是要对MySQL的整体架构和执行原理有一个基础的认知，并不需要记住许多具体细节，因此这篇文章将会对MySQL中的数据组织方式进行一个梳理，同时并不会对于MySQL的底层，例如：某个属性所在的某个字节的具体位置等等（如有需要，请去翻书。 ~~_ps：主要是因为我看了半天实在是记不住_~~ 不是 ）进行细致描述。

## 记录是一切的基础

对于记录大家应该已经相当熟悉了，对于数据库而言，我们最终的目的就是为了对存储在数据库中的记录进行增删改查等操作，同时记录也是MySQL中最基本的数据结构。在MySQL中，不同的存储引擎可能采用不同的记录结构，就算是相同的存储引擎为了满足不同的需求也设计了许多不同的记录结构（例如InnoDB引擎就包含Compact、Redundant、Dynamic和Compressed四种不同的记录结构），这里我们就采用InnoDB的Compact记录结构作为例子。毕竟在日常使用的时候我们实际上很少去改动记录结构。

### Compact记录的结构

![](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/3/12/169710e8fafc21aa~tplv-t2oaga2asx-jj-mark:2268:0:0:0:q75.awebp)

从上图中很容易看出，Compact记录结构主要有两个大部分组成，前面一部分是这条记录的一些额外信息，后面一部分是这条记录所需要保存的真实数据。这个结构本身很符合直觉，没有什么好说的。如果我们的表结构中每一列全部都是定长字段，例如int、char(10)等等，那么只需要把数据直接保存到后面的真实数据部分即可。但是很可惜的是，数据库中还有不少无法确定实际长度的变长字段，例如varchar(10)、blog等等，这类字段的实际长度可能发生变化。对于varchar(10)这样的列还好办一些，反正它可能保存的字符数量是0~10，我们如果浪费一点空间，可以直接按照上限给它分配空间，多少还能存的进去（当然，MySQL中实际上有更好的方式进行存储，这个后面会介绍），但是对于blog这样的字段，我们根本就不能确定它的上限（这么说实际上也不严谨，blog最多可以存储65535个字节，但是这是一个非常大的值，如果按照上限分配空间所需要的空间成本就太难接收了）。

### 变长字段怎么办

让我们先来提取一下上面遇到的问题：

1. 对于较短一些的变长记录，我们可以直接按照上限分配，但是我们不知道这个记录的实际占用长度。
2. 对于较长的边长记录，无法直接存在记录的真实数据中。

OK，明确了问题，接下来就可以逐个击破：

问题1实际上很好解决，我们想要知道一个变长记录的实际长度，一个简单的方法就是直接将这个记录的实际长度记录下来就好了，在Compact记录的额外信息中，有一个变长字段长度列表。这个字段就是用来保存本记录所有变长字段的实际长度。具体是怎么存储的在本文中就不进行详细的说明了，只需要知道保存变长字段的时候会把该字段的实际长度也保存下来就行了，如果想知道的话可以阅读《MySQL是怎样运行的》。

接下来还剩下的问题2就比较棘手了，但是对于这一类不确定长度的问题可以通过一个通用方案来解决，链表！当变长字段内容比较多的时候，在记录的真实数据处存放的就不仅仅是真实数据的值了，同时还会保存一个指针，指向一块专门为变长字段分配的地址。如下图所示
![](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/3/12/169710e9aab47ea5~tplv-t2oaga2asx-jj-mark:2268:0:0:0:q75.awebp)
这样，我们就解决了字段较长，无法直接存放在真实数据中的问题

### NULL字段怎么办

在一条记录中，某些列可能出现NULL值，当该列值为NULL时，我们就不应该访问对应的真实记录。所以应该将这些信息进行保留，当该记录中存在可能为NULL值的列时（只要列的值可能为NULL就需要维护这个列表），将会在额外信息中创建一个NULL值列表，保存对应的NULL值信息。当然，如果一个列中所有的列都不可能为NULL时，自然也就不需要创建NULL值列表了。

### 真实数据中的卧底

在记录的真实数据中，除了我们自己定义的列的数据以外，MySQL为了实现一个其他目的，会为每个记录增加一些隐藏列：
对于record_format_demo表来说，记录的真实数据除了c1、c2、c3、c4这几个我们自己定义的列的数据以外，MySQL会为每个记录默认的添加一些列（也称为隐藏列），具体的列如下：

| 列名 | 是否必须 | 占用空间 | 描述 |
| :----: | :----: | :----: | :----: |
| row_id | 否 | 6字节 | 行ID，唯一标识一条记录 |
| transaction_id | 是 | 6字节 | 事务ID |
| roll_pointer | 是 | 7字节 | 回滚指针 |

其中row_id是一个非必须的列，它的作用是当我们没有为表指定主键，或者唯一列的时候用于充当隐藏主键。所以只要当我们指定了主键或者唯一列的时候自然就不需要创建row_id。剩下的两个列暂时只要看一下就好。

> 小结一下：对于MySQL中的每一条记录有以下几个知识点：
>
> 1. 当列为定长字段时，会将该列的值直接记录在真实数据部分
> 2. 当列为不定长字段时，分为两种情况
    - 当字段较短时，将真实值记录在真实数据部分，同时在额外信息中保存下该字段的真实长度
    - 当字段较长时，真实数据部分将保存该字段的开头部分数据，以及一个指针，用于指向该字段的剩余数据
> 3. 当记录中可能有字段为空值时，会在额外数据中维护一个NULL值列表，保存字段是否为NULL的信息
> 4. 在记录的真实数据部分，除了我们创建的列以外，MySQL会额外添加一些隐藏列